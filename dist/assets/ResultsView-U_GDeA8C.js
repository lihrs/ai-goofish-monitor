import{Q as j,R as Z,d as q,m as ee,S as ue,I as F,q as O,o as g,w as r,s as G,g as te,e,v as z,T as de,i as ce,U as fe,P as ae,a as s,V as me,W as H,r as x,X as pe,Y as Q,p as ve,Z as _e,$ as ye,B as be,c as V,b as y,t as C,A as K,F as le,D as se,f as h,_ as ge,h as I,a0 as he,J as ke,K as xe,L as we,M as $e,N as Ce,O as Re,H as U}from"./index-DH6y1Cde.js";import{u as Fe,g as Ve}from"./useWebSocket-DGP3_34K.js";import{i as P,R as Be,C as Se,_ as N,a as A,b as M,c as X,d as L}from"./SelectValue.vue_vue_type_script_setup_true_lang-C-Sl6ipp.js";import{u as Oe,V as qe}from"./VisuallyHiddenInput-BWXw6jel.js";import{a as Ee,_ as Le}from"./CardContent.vue_vue_type_script_setup_true_lang-AENY5R10.js";import{_ as Ie,a as De,b as Te,c as Ue}from"./CardTitle.vue_vue_type_script_setup_true_lang-CXt5JSnn.js";function Y(o,l){return j(o)?!1:Array.isArray(o)?o.some(t=>P(t,l)):P(o,l)}const[Ne]=Z("CheckboxGroupRoot");function D(o){return o==="indeterminate"}function re(o){return D(o)?"indeterminate":o?"checked":"unchecked"}const[Ae,Me]=Z("CheckboxRoot");var je=q({inheritAttrs:!1,__name:"CheckboxRoot",props:{defaultValue:{type:[Boolean,String],required:!1},modelValue:{type:[Boolean,String,null],required:!1,default:void 0},disabled:{type:Boolean,required:!1},value:{type:null,required:!1,default:"on"},id:{type:String,required:!1},asChild:{type:Boolean,required:!1},as:{type:null,required:!1,default:"button"},name:{type:String,required:!1},required:{type:Boolean,required:!1}},emits:["update:modelValue"],setup(o,{emit:l}){const t=o,i=l,{forwardRef:v,currentElement:b}=ee(),m=Ne(null),f=ue(t,"modelValue",i,{defaultValue:t.defaultValue,passive:t.modelValue===void 0}),c=F(()=>m?.disabled.value||t.disabled),a=F(()=>j(m?.modelValue.value)?f.value==="indeterminate"?"indeterminate":f.value:Y(m.modelValue.value,t.value));function p(){if(j(m?.modelValue.value))f.value=D(f.value)?!0:!f.value;else{const u=[...m.modelValue.value||[]];if(Y(u,t.value)){const $=u.findIndex(E=>P(E,t.value));u.splice($,1)}else u.push(t.value);m.modelValue.value=u}}const w=Oe(b),B=F(()=>t.id&&b.value?document.querySelector(`[for="${t.id}"]`)?.innerText:void 0);return Me({disabled:c,state:a}),(u,$)=>(g(),O(fe(e(m)?.rovingFocus.value?e(Be):e(ae)),z(u.$attrs,{id:u.id,ref:e(v),role:"checkbox","as-child":u.asChild,as:u.as,type:u.as==="button"?"button":void 0,"aria-checked":e(D)(a.value)?"mixed":a.value,"aria-required":u.required,"aria-label":u.$attrs["aria-label"]||B.value,"data-state":e(re)(a.value),"data-disabled":c.value?"":void 0,disabled:c.value,focusable:e(m)?.rovingFocus.value?!c.value:void 0,onKeydown:de(ce(()=>{},["prevent"]),["enter"]),onClick:p}),{default:r(()=>[G(u.$slots,"default",{modelValue:e(f),state:a.value}),e(w)&&u.name&&!e(m)?(g(),O(e(qe),{key:0,type:"checkbox",checked:!!a.value,name:u.name,value:u.value,disabled:c.value,required:u.required},null,8,["checked","name","value","disabled","required"])):te("v-if",!0)]),_:3},16,["id","as-child","as","type","aria-checked","aria-required","aria-label","data-state","data-disabled","disabled","focusable","onKeydown"]))}}),Ke=je,Pe=q({__name:"CheckboxIndicator",props:{forceMount:{type:Boolean,required:!1},asChild:{type:Boolean,required:!1},as:{type:null,required:!1,default:"span"}},setup(o){const{forwardRef:l}=ee(),t=Ae();return(i,v)=>(g(),O(e(me),{present:i.forceMount||e(D)(e(t).state.value)||e(t).state.value===!0},{default:r(()=>[s(e(ae),z({ref:e(l),"data-state":e(re)(e(t).state.value),"data-disabled":e(t).disabled.value?"":void 0,style:{pointerEvents:"none"},"as-child":i.asChild,as:i.as},i.$attrs),{default:r(()=>[G(i.$slots,"default")]),_:3},16,["data-state","data-disabled","as-child","as"])]),_:3},8,["present"]))}}),Ge=Pe;async function ze(){return(await H("/api/results/files")).files||[]}async function He(o){return await H(`/api/results/files/${o}`,{method:"DELETE"})}async function We(o,l={}){return await H(`/api/results/${o}`,{params:l})}function Je(){const o=x([]),l=x(null),t=x([]),i=x(0),v=x(1),b=x(100),m=x({}),f=x(!1),c=x(!1),a=x(!1),p=200;let w=null;const B=pe({recommended_only:!1,sort_by:"crawl_time",sort_order:"desc"}),u=x(!1),$=x(null),{on:E}=Fe();function S(n){return n.trim().toLowerCase().replace(/\s+/g,"_")}function d(n){return n.replace(/_full_data\.jsonl$/i,"").toLowerCase()}async function _(){try{const n=await ze();if(o.value=n,l.value&&n.includes(l.value))return;const k=localStorage.getItem("lastSelectedResultFile");if(k&&n.includes(k)){l.value=k;return}l.value=n[0]||null}catch(n){n instanceof Error&&($.value=n)}finally{c.value=!0,J()}}async function T(){if(!l.value){t.value=[],i.value=0;return}u.value=!0,$.value=null;try{const n=await We(l.value,{...B,page:v.value,limit:b.value});t.value=n.items,i.value=n.total_items}catch(n){n instanceof Error&&($.value=n),t.value=[],i.value=0}finally{u.value=!1}}async function W(){try{const n=await Ve(),k={};n.forEach(R=>{R.keyword&&(k[S(R.keyword)]=R.task_name)}),m.value=k}catch(n){n instanceof Error&&($.value=n)}finally{a.value=!0,J()}}function J(){f.value||!c.value||!a.value||w||(w=setTimeout(()=>{f.value=!0,w=null},p))}E("results_updated",async()=>{const n=l.value;await _(),l.value&&l.value===n&&T()}),E("tasks_updated",()=>{W()});async function ne(){const n=l.value;await _(),l.value&&l.value===n&&await T()}async function oe(n){const k=n||l.value;if(k){u.value=!0,$.value=null;try{await He(k),l.value===k&&localStorage.getItem("lastSelectedResultFile")===k&&localStorage.removeItem("lastSelectedResultFile"),await _()}catch(R){throw R instanceof Error&&($.value=R),R}finally{u.value=!1}}}Q([l,B],T,{deep:!0}),Q(l,n=>{n&&localStorage.setItem("lastSelectedResultFile",n)});const ie=F(()=>o.value.map(n=>{const k=d(n),R=m.value[k];return{value:n,label:`任务名称：${R||"未命名"}`}}));return ve(()=>{_(),W()}),{files:o,selectedFile:l,results:t,totalItems:i,filters:B,isLoading:u,error:$,fetchFiles:_,refreshResults:ne,deleteSelectedFile:oe,fileOptions:ie,isFileOptionsReady:f}}const Qe=q({__name:"Checkbox",props:{defaultValue:{type:[Boolean,String]},modelValue:{type:[Boolean,String,null]},disabled:{type:Boolean},value:{},id:{},asChild:{type:Boolean},as:{},name:{},required:{type:Boolean},class:{}},emits:["update:modelValue"],setup(o,{emit:l}){const t=o,i=l,v=_e(t,"class"),b=ye(v,i);return(m,f)=>(g(),O(e(Ke),z(e(b),{class:e(be)("grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",t.class)}),{default:r(()=>[s(e(Ge),{class:"grid place-content-center text-current"},{default:r(()=>[G(m.$slots,"default",{},()=>[s(e(Se),{class:"h-4 w-4"})])]),_:3})]),_:3},16,["class"]))}}),Xe={class:"flex flex-wrap gap-4 items-center mb-6 p-4 bg-gray-50 rounded-lg border"},Ye={class:"flex items-center space-x-2"},Ze=q({__name:"ResultsFilterBar",props:{files:{},fileOptions:{},selectedFile:{},recommendedOnly:{type:Boolean},sortBy:{},sortOrder:{},isLoading:{type:Boolean},isReady:{type:Boolean}},emits:["update:selectedFile","update:recommendedOnly","update:sortBy","update:sortOrder","refresh","delete"],setup(o,{emit:l}){const t=o,i=F(()=>t.isReady?t.fileOptions&&t.fileOptions.length>0?t.fileOptions:t.files.map(c=>({value:c,label:c})):[]),v=F(()=>{if(!t.isReady)return"加载任务名称...";if(i.value.length===0)return"暂无结果，请先运行任务";if(!t.selectedFile)return"请选择任务结果";const c=i.value.find(a=>a.value===t.selectedFile);return c?c.label:"任务名称：未命名"}),b=F(()=>{const c=["transition-opacity","duration-200"];return(!t.isReady||!t.selectedFile||i.value.length===0)&&c.push("text-muted-foreground"),c.push(t.isReady?"opacity-100":"opacity-70"),c.join(" ")}),m=F(()=>!t.isReady||i.value.length===0),f=l;return(c,a)=>(g(),V("div",Xe,[s(e(N),{"model-value":t.selectedFile||void 0,"onUpdate:modelValue":a[0]||(a[0]=p=>f("update:selectedFile",p))},{default:r(()=>[s(e(A),{class:"w-[280px]",disabled:m.value},{default:r(()=>[y("span",{class:K(b.value)},C(v.value),3)]),_:1},8,["disabled"]),s(e(M),null,{default:r(()=>[(g(!0),V(le,null,se(i.value,p=>(g(),O(e(L),{key:p.value,value:p.value},{default:r(()=>[h(C(p.label),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["model-value"]),s(e(N),{"model-value":t.sortBy,"onUpdate:modelValue":a[1]||(a[1]=p=>f("update:sortBy",p))},{default:r(()=>[s(e(A),{class:"w-[180px]"},{default:r(()=>[s(e(X))]),_:1}),s(e(M),null,{default:r(()=>[s(e(L),{value:"crawl_time"},{default:r(()=>[...a[6]||(a[6]=[h("按爬取时间",-1)])]),_:1}),s(e(L),{value:"publish_time"},{default:r(()=>[...a[7]||(a[7]=[h("按发布时间",-1)])]),_:1}),s(e(L),{value:"price"},{default:r(()=>[...a[8]||(a[8]=[h("按价格",-1)])]),_:1})]),_:1})]),_:1},8,["model-value"]),s(e(N),{"model-value":t.sortOrder,"onUpdate:modelValue":a[2]||(a[2]=p=>f("update:sortOrder",p))},{default:r(()=>[s(e(A),{class:"w-[120px]"},{default:r(()=>[s(e(X))]),_:1}),s(e(M),null,{default:r(()=>[s(e(L),{value:"desc"},{default:r(()=>[...a[9]||(a[9]=[h("降序",-1)])]),_:1}),s(e(L),{value:"asc"},{default:r(()=>[...a[10]||(a[10]=[h("升序",-1)])]),_:1})]),_:1})]),_:1},8,["model-value"]),y("div",Ye,[s(e(Qe),{id:"recommended-only",checked:t.recommendedOnly,"onUpdate:checked":a[3]||(a[3]=p=>f("update:recommendedOnly",!!p))},null,8,["checked"]),s(e(ge),{for:"recommended-only",class:"cursor-pointer"},{default:r(()=>[...a[11]||(a[11]=[h("仅看AI推荐",-1)])]),_:1})]),s(e(I),{onClick:a[4]||(a[4]=p=>f("refresh")),disabled:t.isLoading},{default:r(()=>[...a[12]||(a[12]=[h(" 刷新 ",-1)])]),_:1},8,["disabled"]),s(e(I),{variant:"destructive",onClick:a[5]||(a[5]=p=>f("delete")),disabled:t.isLoading||!t.selectedFile},{default:r(()=>[...a[13]||(a[13]=[h(" 删除结果 ",-1)])]),_:1},8,["disabled"])]))}}),et={class:"aspect-[4/3] bg-gray-100 rounded-t-lg overflow-hidden -mt-6 -mx-6"},tt=["href"],at=["src","alt"],lt=["href"],st={class:"mt-1 text-gray-600 line-clamp-3"},rt={class:"space-y-1"},nt={class:"block"},ot={class:"block"},it={class:"block"},ut=["href"],dt=q({__name:"ResultCard",props:{item:{}},setup(o){const l=o,t=l.item.商品信息,i=l.item.卖家信息,v=l.item.ai_analysis,b=v?.is_recommended===!0,m=b?"推荐":v?.is_recommended===!1?"不推荐":"待定",f=t.商品图片列表?.[0]||t.商品主图链接||"",c=l.item.爬取时间?new Date(l.item.爬取时间).toLocaleString("sv-SE"):"未知",a=t.发布时间||"未知";return(p,w)=>(g(),O(e(Ee),{class:"flex flex-col h-full"},{default:r(()=>[s(e(Ie),null,{default:r(()=>[y("div",et,[y("a",{href:e(t).商品链接,target:"_blank",rel:"noopener noreferrer"},[y("img",{src:e(f),alt:e(t).商品标题,class:"w-full h-full object-cover transition-transform hover:scale-105",loading:"lazy"},null,8,at)],8,tt)]),s(e(De),{class:"pt-4"},{default:r(()=>[y("a",{href:e(t).商品链接,target:"_blank",rel:"noopener noreferrer",class:"hover:text-blue-600 line-clamp-2"},C(e(t).商品标题),9,lt)]),_:1}),s(e(Te),{class:"text-xl font-bold text-red-600 !mt-2"},{default:r(()=>[h(C(e(t).当前售价),1)]),_:1})]),_:1}),s(e(Le),{class:"flex-grow"},{default:r(()=>[y("div",{class:K(["p-3 rounded-md text-sm",b?"bg-green-50 border border-green-200":"bg-red-50 border border-red-200"])},[y("p",{class:K(["font-semibold",[b?"text-green-800":"text-red-800"]])}," AI建议: "+C(e(m)),3),y("p",st," 原因: "+C(e(v)?.reason||"无"),1)],2)]),_:1}),s(e(Ue),{class:"text-xs text-gray-500 flex items-center justify-between gap-2"},{default:r(()=>[y("div",rt,[y("span",nt,"卖家: "+C(e(i).卖家昵称||e(t).卖家昵称||"未知"),1),y("span",ot,"发布于: "+C(e(a)),1),y("span",it,"抓取于: "+C(e(c)),1)]),y("a",{href:e(t).商品链接,target:"_blank",rel:"noopener noreferrer",class:"text-blue-600 hover:underline text-sm"}," 查看详情 ",8,ut)]),_:1})]),_:1}))}}),ct={key:0,class:"text-center py-12 text-gray-500"},ft={key:1,class:"text-center py-12 text-gray-500"},mt={key:2,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"},pt=q({__name:"ResultsGrid",props:{results:{},isLoading:{type:Boolean}},setup(o){return(l,t)=>(g(),V("div",null,[o.isLoading?(g(),V("div",ct," 正在加载结果... ")):o.results.length===0?(g(),V("div",ft," 没有找到符合条件的商品记录。 ")):(g(),V("div",mt,[(g(!0),V(le,null,se(o.results,i=>(g(),O(dt,{key:i.商品信息.商品ID,item:i},null,8,["item"]))),128))]))]))}}),vt={key:0,class:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",role:"alert"},_t={class:"block sm:inline"},wt=q({__name:"ResultsView",setup(o){const{files:l,selectedFile:t,results:i,filters:v,isLoading:b,error:m,refreshResults:f,deleteSelectedFile:c,fileOptions:a,isFileOptionsReady:p}=Je(),w=x(!1),B=F(()=>{if(!t.value||a.value.length===0)return null;const S=a.value.find(_=>_.value===t.value);return S&&S.label.replace(/^任务名称：/,"").trim()||null}),u=F(()=>B.value?`确定删除任务结果「${B.value}」吗？此操作不可恢复。`:"确定删除该任务结果吗？此操作不可恢复。");function $(){if(!t.value){U({title:"暂无可删除的结果",variant:"destructive"});return}w.value=!0}async function E(){if(t.value)try{await c(t.value),U({title:"结果已删除"})}catch(S){U({title:"删除结果失败",description:S.message,variant:"destructive"})}finally{w.value=!1}}return(S,d)=>(g(),V("div",null,[d[10]||(d[10]=y("h1",{class:"text-2xl font-bold text-gray-800 mb-6"}," 结果查看 ",-1)),e(m)?(g(),V("div",vt,[d[6]||(d[6]=y("strong",{class:"font-bold"},"出错了!",-1)),y("span",_t,C(e(m).message),1)])):te("",!0),s(Ze,{files:e(l),"file-options":e(a),"is-ready":e(p),selectedFile:e(t),"onUpdate:selectedFile":d[0]||(d[0]=_=>he(t)?t.value=_:null),recommendedOnly:e(v).recommended_only,"onUpdate:recommendedOnly":d[1]||(d[1]=_=>e(v).recommended_only=_),sortBy:e(v).sort_by,"onUpdate:sortBy":d[2]||(d[2]=_=>e(v).sort_by=_),sortOrder:e(v).sort_order,"onUpdate:sortOrder":d[3]||(d[3]=_=>e(v).sort_order=_),"is-loading":e(b),onRefresh:e(f),onDelete:$},null,8,["files","file-options","is-ready","selectedFile","recommendedOnly","sortBy","sortOrder","is-loading","onRefresh"]),s(pt,{results:e(i),"is-loading":e(b)},null,8,["results","is-loading"]),s(e(Re),{open:w.value,"onUpdate:open":d[5]||(d[5]=_=>w.value=_)},{default:r(()=>[s(e(ke),{class:"sm:max-w-[420px]"},{default:r(()=>[s(e(xe),null,{default:r(()=>[s(e(we),null,{default:r(()=>[...d[7]||(d[7]=[h("删除任务结果",-1)])]),_:1}),s(e($e),null,{default:r(()=>[h(C(u.value),1)]),_:1})]),_:1}),s(e(Ce),null,{default:r(()=>[s(e(I),{variant:"outline",onClick:d[4]||(d[4]=_=>w.value=!1)},{default:r(()=>[...d[8]||(d[8]=[h("取消",-1)])]),_:1}),s(e(I),{variant:"destructive",disabled:e(b),onClick:E},{default:r(()=>[...d[9]||(d[9]=[h(" 确认删除 ",-1)])]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])]))}});export{wt as default};
